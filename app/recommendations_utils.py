from app.models import Recommendation
from app import db
from datetime import datetime


class RecommendationsManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏"""

    # –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)
    DEFAULT_RECOMMENDATIONS = {
        'happy': [
            '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º —Å—á–∞—Å—Ç—å–µ–º —Å –¥—Ä—É–≥–∏–º–∏! üåü',
            '–ó–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Å–¥–µ–ª–∞–ª–æ –≤–∞—Å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º —Å–µ–≥–æ–¥–Ω—è',
            '–°–¥–µ–ª–∞–π—Ç–µ —á—Ç–æ-—Ç–æ –¥–æ–±—Ä–æ–µ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞',
            '–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —ç—Ç–∏–º –º–æ–º–µ–Ω—Ç–æ–º –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ –∑–∞ –Ω–µ–≥–æ',
            '–°–æ–∑–¥–∞–π—Ç–µ "–∫–æ–ª–ª–µ–∫—Ü–∏—é —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤"'
        ],
        'calm': [
            '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≥–ª—É–±–æ–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ 5 –º–∏–Ω—É—Ç',
            '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è',
            '–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —Ç–∏—à–∏–Ω–æ–π –∏ –ø–æ–∫–æ–µ–º',
            '–ü–æ–≥—É–ª—è–π—Ç–µ –Ω–∞ –ø—Ä–∏—Ä–æ–¥–µ –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ',
            '–ó–∞–≤–∞—Ä–∏—Ç–µ —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π –∏ –ø–æ—á–∏—Ç–∞–π—Ç–µ –∫–Ω–∏–≥—É'
        ],
        'neutral': [
            '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏ –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
            '–ü–æ—Å—Ç–∞–≤—å—Ç–µ –º–∞–ª–µ–Ω—å–∫—É—é —Ü–µ–ª—å –∏ –¥–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ –µ–µ',
            '–ü–æ—Å–ª—É—à–∞–π—Ç–µ –º—É–∑—ã–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
            '–í—Å—Ç—Ä–µ—Ç—å—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏',
            '–°–¥–µ–ª–∞–π—Ç–µ —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è'
        ],
        'sad': [
            '–ü–æ—Å–ª—É—à–∞–π—Ç–µ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É üéµ',
            '–ü—Ä–æ–≥—É–ª—è–π—Ç–µ—Å—å –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ',
            '–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –±–ª–∏–∑–∫–æ–º—É —á–µ–ª–æ–≤–µ–∫—É',
            '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª—é–±–∏–º—ã–π —Ñ–∏–ª—å–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª',
            '–ù–∞–ø–∏—à–∏—Ç–µ –æ —Å–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö –≤ –¥–Ω–µ–≤–Ω–∏–∫'
        ],
        'angry': [
            '–°–¥–µ–ª–∞–π—Ç–µ 10 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–æ–≤ –∏ –≤—ã–¥–æ—Ö–æ–≤',
            '–ó–∞–π–º–∏—Ç–µ—Å—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é',
            '–í—ã—Ä–∞–∑–∏—Ç–µ —ç–º–æ—Ü–∏–∏ –Ω–∞ –±—É–º–∞–≥–µ, –∑–∞—Ç–µ–º –ø–æ—Ä–≤–∏—Ç–µ –µ–µ',
            '–û—Ç–≤–ª–µ–∫–∏—Ç–µ—Å—å –Ω–∞ 10 –º–∏–Ω—É—Ç –Ω–∞ –¥—Ä—É–≥—É—é –∑–∞–¥–∞—á—É',
            '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç–µ –æ –ø—Ä–æ–±–ª–µ–º–µ —Å –∫–µ–º-—Ç–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º'
        ],
        'anxious': [
            '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É 5-4-3-2-1: –Ω–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ, 4 - –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ, 3 - –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, 2 - –∫–æ—Ç–æ—Ä—ã–µ –Ω—é—Ö–∞–µ—Ç–µ, 1 - –∫–æ—Ç–æ—Ä—É—é –ø—Ä–æ–±—É–µ—Ç–µ',
            '–°–¥–µ–ª–∞–π—Ç–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
            '–°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å',
            '–ü—Ä–∏–º–∏—Ç–µ —Ç–µ–ø–ª—ã–π –¥—É—à –∏–ª–∏ –≤–∞–Ω–Ω—É',
            '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ'
        ],
        'excited': [
            '–ù–∞–ø—Ä–∞–≤—å—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç',
            '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –≤–æ—Å—Ç–æ—Ä–≥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏',
            '–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —á—Ç–æ-—Ç–æ –≤–µ—Å–µ–ª–æ–µ –Ω–∞ –±—É–¥—É—â–µ–µ',
            '–¢–∞–Ω—Ü—É–π—Ç–µ –ø–æ–¥ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É',
            '–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –∏–¥–µ–∏ –∏ –ø–ª–∞–Ω—ã'
        ],
        'tired': [
            '–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ 20-30 –º–∏–Ω—É—Ç –±–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤',
            '–í—ã–ø–µ–π—Ç–µ —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –∏ —Å—ä–µ—à—å—Ç–µ —á—Ç–æ-—Ç–æ –ª–µ–≥–∫–æ–µ',
            '–°–¥–µ–ª–∞–π—Ç–µ –ª–µ–≥–∫—É—é —Ä–∞—Å—Ç—è–∂–∫—É',
            '–ü–æ—Å–ª—É—à–∞–π—Ç–µ —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â—É—é –º—É–∑—ã–∫—É',
            '–õ–æ–∂–∏—Ç–µ—Å—å —Å–ø–∞—Ç—å –Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ —Å–µ–≥–æ–¥–Ω—è'
        ]
    }

    @staticmethod
    def initialize_default_recommendations():
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if Recommendation.query.first() is not None:
                print("‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
                return

            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            for mood, advice_list in RecommendationsManager.DEFAULT_RECOMMENDATIONS.items():
                for i, advice in enumerate(advice_list, 1):
                    recommendation = Recommendation(
                        mood=mood,
                        advice=advice,
                        category='default',
                        priority=i  # –ü–µ—Ä–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ
                    )
                    db.session.add(recommendation)

            db.session.commit()
            print(
                f"‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(RecommendationsManager.DEFAULT_RECOMMENDATIONS)} –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏")

        except Exception as e:
            db.session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")

    @staticmethod
    def get_recommendations_for_mood(mood, limit=3):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            recommendations = Recommendation.query.filter_by(
                mood=mood
            ).order_by(Recommendation.priority.asc()).limit(limit).all()

            # –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            if not recommendations:
                advice_list = RecommendationsManager.DEFAULT_RECOMMENDATIONS.get(mood, [])
                return advice_list[:limit]

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ç—Ä–æ–∫–∏
            return [rec.advice for rec in recommendations]

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            advice_list = RecommendationsManager.DEFAULT_RECOMMENDATIONS.get(mood, [])
            return advice_list[:limit]

    @staticmethod
    def get_all_moods_with_recommendations():
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã
            moods = db.session.query(Recommendation.mood).distinct().all()
            return [mood[0] for mood in moods]
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π: {e}")
            return list(RecommendationsManager.DEFAULT_RECOMMENDATIONS.keys())

    @staticmethod
    def add_recommendation(mood, advice, category='custom', priority=1):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"""
        try:
            recommendation = Recommendation(
                mood=mood,
                advice=advice,
                category=category,
                priority=priority
            )
            db.session.add(recommendation)
            db.session.commit()
            return True, "‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞"
        except Exception as e:
            db.session.rollback()
            return False, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: {e}"