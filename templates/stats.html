{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è - VibeMe{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h2 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h2>
                
                <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="display-6">{{ total_entries }}</h3>
                                <p class="text-muted">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="display-6">{{ most_common_mood or '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}</h3>
                                <p class="text-muted">–°–∞–º–æ–µ —á–∞—Å—Ç–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="display-6">{{ mood_entries|length if mood_entries else 0 }}/10</h3>
                                <p class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-md-6">
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h4 class="mb-3">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π</h4>
                <div class="chart-container">
                    <canvas id="moodDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ -->
    <div class="col-md-6">
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h4 class="mb-3">üìÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏</h4>
                <div class="chart-container">
                    <canvas id="moodTimelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
<div class="row">
    <div class="col-md-12">
        <div class="card card-custom">
            <div class="card-body">
                <h4 class="mb-3">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h4>
                {% if mood_entries %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</th>
                                    <th>–ó–∞–º–µ—Ç–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in mood_entries|reverse %}
                                <tr>
                                    <td>{{ entry.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td>
                                        {% if entry.mood == 'happy' %}üòä –°—á–∞—Å—Ç–ª–∏–≤
                                        {% elif entry.mood == 'calm' %}üòå –°–ø–æ–∫–æ–µ–Ω
                                        {% elif entry.mood == 'neutral' %}üòê –ù–µ–π—Ç—Ä–∞–ª–µ–Ω
                                        {% elif entry.mood == 'sad' %}üòî –ì—Ä—É—Å—Ç–µ–Ω
                                        {% elif entry.mood == 'angry' %}üò† –°–µ—Ä–¥–∏—Ç
                                        {% elif entry.mood == 'anxious' %}üò∞ –¢—Ä–µ–≤–æ–∂–µ–Ω
                                        {% elif entry.mood == 'excited' %}üéâ –í –≤–æ—Å—Ç–æ—Ä–≥–µ
                                        {% elif entry.mood == 'tired' %}üò¥ –£—Å—Ç–∞–ª
                                        {% else %}{{ entry.mood }}{% endif %}
                                    </td>
                                    <td>{{ entry.notes|truncate(50) if entry.notes else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.</p>
                    <a href="{{ url_for('main.mood_form') }}" class="btn btn-custom">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
<div class="row mt-4">
    <div class="col-md-12 text-center">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-custom">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–∞
const chartLabels = {{ chart_labels|tojson }};
const chartData = {{ chart_data|tojson }};
const timelineData = {{ timeline_data|tojson }};

// –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const chartColors = [
    '#FF6384', // happy
    '#36A2EB', // calm
    '#FFCE56', // neutral
    '#4BC0C0', // sad
    '#9966FF', // angry
    '#FF9F40', // anxious
    '#C9CBCF', // excited
    '#2E8B57'  // tired
];

// 1. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
const distributionCtx = document.getElementById('moodDistributionChart').getContext('2d');
const distributionChart = new Chart(distributionCtx, {
    type: 'pie',
    data: {
        labels: chartLabels,
        datasets: [{
            data: chartData,
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    font: {
                        size: 11
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += context.raw + ' –∑–∞–ø–∏—Å–µ–π';
                        return label;
                    }
                }
            }
        }
    }
});

// 2. –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏
if (timelineData.length > 0) {
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ (—Å—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å)
    const groupedData = {};
    timelineData.forEach(entry => {
        if (!groupedData[entry.date]) {
            groupedData[entry.date] = {
                moods: [],
                count: 0
            };
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const moodValues = {
            'happy': 1,
            'excited': 2,
            'calm': 3,
            'neutral': 4,
            'tired': 5,
            'sad': 6,
            'anxious': 7,
            'angry': 8
        };
        
        groupedData[entry.date].moods.push(moodValues[entry.mood] || 4);
        groupedData[entry.date].count++;
    });
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    const timelineLabels = Object.keys(groupedData);
    const timelineAverages = timelineLabels.map(date => {
        const moods = groupedData[date].moods;
        const sum = moods.reduce((a, b) => a + b, 0);
        return sum / moods.length;
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∫–∞–ª—É Y —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
    const moodScaleLabels = {
        1: 'üòä –°—á–∞—Å—Ç–ª–∏–≤',
        2: 'üéâ –í –≤–æ—Å—Ç–æ—Ä–≥–µ',
        3: 'üòå –°–ø–æ–∫–æ–µ–Ω',
        4: 'üòê –ù–µ–π—Ç—Ä–∞–ª–µ–Ω',
        5: 'üò¥ –£—Å—Ç–∞–ª',
        6: 'üòî –ì—Ä—É—Å—Ç–µ–Ω',
        7: 'üò∞ –¢—Ä–µ–≤–æ–∂–µ–Ω',
        8: 'üò† –°–µ—Ä–¥–∏—Ç'
    };
    
    const timelineCtx = document.getElementById('moodTimelineChart').getContext('2d');
    const timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: timelineLabels,
            datasets: [{
                label: '–£—Ä–æ–≤–µ–Ω—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',
                data: timelineAverages,
                borderColor: 'rgba(177, 156, 217, 1)',
                backgroundColor: 'rgba(177, 156, 217, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(177, 156, 217, 1)',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false,
                    min: 0.5,
                    max: 8.5,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return moodScaleLabels[value] || '';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxTicksLimit: 10
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const mood = Object.keys(moodScaleLabels).find(key => 
                                Math.abs(value - key) < 0.5
                            );
                            return `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${moodScaleLabels[mood] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
                        }
                    }
                }
            }
        }
    });
} else {
    document.getElementById('moodTimelineChart').parentElement.innerHTML = 
        '<p class="text-muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π!</p>';
}
</script>

<style>
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}
.table th {
    background-color: var(--light-pink);
    border-top: none;
}
</style>
{% endblock %}